name: Deploy to Render

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  backend_flask:
    name: Backend (Flask)
    runs-on: ubuntu-latest

    steps:
      # Checkout the repository
      - uses: actions/checkout@v3

      # Set up Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      # Install Python dependencies and Test Runner ⚙️
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          # Install production dependencies
          if [ -f backend/requirements.txt ]; then pip install -r backend/requirements.txt; fi
          # Install quality/testing tools globally for the job
          pip install flake8 pytest pytest-cov black bandit

      # Check Black formatting 🎨
      - name: Check Python code formatting (Black)
        run: |
          # The --check flag verifies formatting without applying changes
          black --check backend/

      # Lint Python code (Flake8) 🔍
      - name: Lint Python code (Flake8)
        run: |
          # Only run flake8 on the backend directory
          flake8 backend/

      # Run Python Security Scan (Bandit) 🔒
      - name: Run Python Security Scan (Bandit)
        run: |
          # Scan the backend for security issues, excluding the test files
          bandit -r backend -ll -x backend/tests

      # Run Python tests with Coverage ✅
      - name: Run Python tests with Coverage
        run: |
          # Run pytest, generate coverage report, and fail if coverage is < 80%
          pytest --cov=backend --cov-report=term --cov-fail-under=80 backend/tests/
